{"ast":null,"code":"/*\n  \n*/\nvar Refiner = require('../refiner').Refiner;\n\nexports.Refiner = function ENMergeDateRangeRefiner() {\n  Refiner.call(this);\n\n  this.pattern = function () {\n    return /^\\s*(to|\\-)\\s*$/i;\n  };\n\n  this.refine = function (text, results, opt) {\n    if (results.length < 2) return results;\n    var mergedResult = [];\n    var currResult = null;\n    var prevResult = null;\n\n    for (var i = 1; i < results.length; i++) {\n      currResult = results[i];\n      prevResult = results[i - 1];\n\n      if (!prevResult.end && !currResult.end && this.isAbleToMerge(text, prevResult, currResult)) {\n        prevResult = this.mergeResult(text, prevResult, currResult);\n        currResult = null;\n        i += 1;\n      }\n\n      mergedResult.push(prevResult);\n    }\n\n    if (currResult != null) {\n      mergedResult.push(currResult);\n    }\n\n    return mergedResult;\n  };\n\n  this.isAbleToMerge = function (text, result1, result2) {\n    var begin = result1.index + result1.text.length;\n    var end = result2.index;\n    var textBetween = text.substring(begin, end);\n    return textBetween.match(this.pattern());\n  };\n\n  this.isWeekdayResult = function (result) {\n    return result.start.isCertain('weekday') && !result.start.isCertain('day');\n  };\n\n  this.mergeResult = function (text, fromResult, toResult) {\n    if (!this.isWeekdayResult(fromResult) && !this.isWeekdayResult(toResult)) {\n      var timeKeys = {\n        'hour': true,\n        'minute': true,\n        'second': true\n      };\n\n      for (var key in toResult.start.knownValues) {\n        if (!fromResult.start.isCertain(key)) {\n          fromResult.start.assign(key, toResult.start.get(key));\n        }\n      }\n\n      for (var key in fromResult.start.knownValues) {\n        if (!toResult.start.isCertain(key)) {\n          toResult.start.assign(key, fromResult.start.get(key));\n        }\n      }\n    }\n\n    if (fromResult.start.date().getTime() > toResult.start.date().getTime()) {\n      var fromMoment = fromResult.start.moment();\n      var toMoment = toResult.start.moment();\n\n      if (this.isWeekdayResult(fromResult) && fromMoment.clone().add(-7, 'days').isBefore(toMoment)) {\n        fromMoment = fromMoment.add(-7, 'days');\n        fromResult.start.imply('day', fromMoment.date());\n        fromResult.start.imply('month', fromMoment.month() + 1);\n        fromResult.start.imply('year', fromMoment.year());\n      } else if (this.isWeekdayResult(toResult) && toMoment.clone().add(7, 'days').isAfter(fromMoment)) {\n        toMoment = toMoment.add(7, 'days');\n        toResult.start.imply('day', toMoment.date());\n        toResult.start.imply('month', toMoment.month() + 1);\n        toResult.start.imply('year', toMoment.year());\n      } else {\n        var tmp = toResult;\n        toResult = fromResult;\n        fromResult = tmp;\n      }\n    }\n\n    fromResult.end = toResult.start;\n\n    for (var tag in toResult.tags) {\n      fromResult.tags[tag] = true;\n    }\n\n    var startIndex = Math.min(fromResult.index, toResult.index);\n    var endIndex = Math.max(fromResult.index + fromResult.text.length, toResult.index + toResult.text.length);\n    fromResult.index = startIndex;\n    fromResult.text = text.substring(startIndex, endIndex);\n    fromResult.tags[this.constructor.name] = true;\n    return fromResult;\n  };\n};","map":null,"metadata":{},"sourceType":"script"}